<!DOCTYPE html>
<html>
<head>
    <title>Product Categories Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .product-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f9f9f9;
        }
        .product-image {
            height: 150px;
            background: #eee;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .product-image img {
            max-width: 100%;
            max-height: 100%;
        }
        .view-products-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        #debug-info {
            background: #f0f0f0;
            padding: 10px;
            border: 1px solid #ddd;
            margin-top: 20px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>Product Categories Test Page</h1>
    <p>This page tests loading product categories from Google Sheets.</p>
    
    <div class="products-grid" id="products-grid">
        <!-- Product categories will be loaded here -->
        <div class="product-card">
            <div class="product-image">Loading...</div>
            <h3>Loading categories...</h3>
            <p>Please wait while we fetch the product data.</p>
        </div>
    </div>
    
    <div id="debug-info">Debug information will appear here...</div>
    
    <script>
        // Simple version of the product data structure
        let productData = {};
        const debugInfo = document.getElementById('debug-info');
        const productsGrid = document.getElementById('products-grid');
        
        // Log to both console and the debug div
        function log(message, data) {
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            const msg = `[${timestamp}] ${message}`;
            console.log(msg, data);
            
            let displayData = '';
            if (data !== undefined) {
                try {
                    displayData = typeof data === 'object' ? 
                        ': ' + JSON.stringify(data, null, 2) : 
                        ': ' + data;
                } catch (e) {
                    displayData = ': [Complex Object]';
                }
            }
            
            debugInfo.textContent += msg + displayData + '\n';
        }
        
        // Fetch product data from Google Sheet
        async function fetchProductData() {
            log('Starting to fetch product data');
            
            try {
                const SHEET_ID = '17OUHOS-Xhqmto_67ZbLMbWNnI7LgoDXswb3VwOvbkCUE';
                const sheetURL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
                
                log('Fetching from URL', sheetURL);
                const response = await fetch(sheetURL);
                log('Response status', response.status);
                
                const text = await response.text();
                log('Response text length', text.length);
                
                // Google's response is not pure JSON, it has a prefix we need to remove
                const jsonStart = text.indexOf('{');
                const jsonEnd = text.lastIndexOf('}') + 1;
                if (jsonStart < 0 || jsonEnd <= 0) {
                    throw new Error('Invalid response format');
                }
                
                const jsonText = text.substring(jsonStart, jsonEnd);
                log('JSON text extracted', jsonText.substring(0, 100) + '...');
                
                const data = JSON.parse(jsonText);
                log('Data parsed successfully', Object.keys(data));
                
                // Process the data into our structure
                processSheetData(data.table);
                
                // After processing, populate the UI
                populateProductCategories();
                
                log('Product data loaded successfully', Object.keys(productData));
            } catch (error) {
                log('Error fetching product data', error.message);
                
                // Fallback to sample data if fetch fails
                loadSampleData();
            }
        }
        
        // Process the sheet data into our structure
        function processSheetData(tableData) {
            log('Processing sheet data', tableData ? 'Table data exists' : 'No table data');
            
            // Clear existing data
            productData = {};
            
            if (!tableData || !tableData.rows) {
                log('No rows in table data');
                return;
            }
            
            log('Number of rows', tableData.rows.length);
            
            // Skip the header row (row 0)
            for (let i = 1; i < tableData.rows.length; i++) {
                const row = tableData.rows[i].c;
                if (!row) continue;
                
                // Extract data from each row
                const productId = row[0]?.v || '';
                const name = row[1]?.v || '';
                const category = row[2]?.v || 'Uncategorized';
                const description = row[3]?.v || '';
                const price = parseFloat(row[4]?.v) || 0;
                const availability = row[5]?.v || 'In Stock';
                
                log(`Row ${i}`, { productId, name, category, price });
                
                // Create category if it doesn't exist
                if (!productData[category]) {
                    productData[category] = {
                        description: `${category} from Suruli Greens`,
                        image: `https://source.unsplash.com/300x200/?${encodeURIComponent(category.toLowerCase())}`,
                        products: []
                    };
                }
                
                // Add product to category
                productData[category].products.push({
                    id: productId,
                    name: name,
                    description: description,
                    price: price,
                    availability: availability
                });
            }
            
            log('Categories created', Object.keys(productData));
        }
        
        // Populate product categories in the grid
        function populateProductCategories() {
            log('Populating product categories');
            
            if (!productsGrid) {
                log('Products grid not found');
                return;
            }
            
            // Clear existing content
            productsGrid.innerHTML = '';
            
            const categories = Object.keys(productData);
            log('Number of categories to display', categories.length);
            
            if (categories.length === 0) {
                productsGrid.innerHTML = '<div class="product-card"><p>No product categories found.</p></div>';
                return;
            }
            
            // Add each product category
            for (const categoryName of categories) {
                const category = productData[categoryName];
                
                const categoryCard = document.createElement('div');
                categoryCard.classList.add('product-card');
                categoryCard.dataset.category = categoryName;
                
                categoryCard.innerHTML = `
                    <div class="product-image">
                        <img src="${category.image}" alt="${categoryName}" onerror="this.src='https://via.placeholder.com/300x200?text=${encodeURIComponent(categoryName)}'" />
                    </div>
                    <h3>${categoryName}</h3>
                    <p>${category.description}</p>
                    <div class="product-price">From ₹${getLowestPrice(category.products)}</div>
                    <button class="view-products-btn" data-category="${categoryName}">View Products</button>
                `;
                
                productsGrid.appendChild(categoryCard);
            }
            
            // Add click events to the View Products buttons
            document.querySelectorAll('.view-products-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const categoryName = this.dataset.category;
                    log('Category clicked', categoryName);
                    alert(`Products in ${categoryName} category:\n\n` + 
                          productData[categoryName].products
                            .map(p => `${p.name}: ₹${p.price} - ${p.availability}`)
                            .join('\n'));
                });
            });
            
            log('Categories populated successfully');
        }
        
        // Get the lowest price from a category's products
        function getLowestPrice(products) {
            if (!products || products.length === 0) return 0;
            return Math.min(...products.map(product => product.price));
        }
        
        // Load sample data in case the Google Sheet fetch fails
        function loadSampleData() {
            log('Loading sample data');
            
            productData = {
                "Fresh Microgreens": {
                    description: "Nutrient-dense microgreens grown hydroponically",
                    image: "https://source.unsplash.com/300x200/?microgreens",
                    products: [
                        { id: "MG001", name: "Sunflower Microgreens", description: "Nutty flavor crunchy texture 30g pack", price: 120, availability: "In Stock" },
                        { id: "MG002", name: "Pea Shoot Microgreens", description: "Sweet pea flavor tender shoots 30g pack", price: 140, availability: "In Stock" }
                    ]
                },
                "Hydroponic Greens": {
                    description: "Fresh leafy greens grown in our hydroponic system",
                    image: "https://source.unsplash.com/300x200/?hydroponic",
                    products: [
                        { id: "HG001", name: "Lettuce - Romaine", description: "Crisp sweet lettuce 100g pack", price: 80, availability: "In Stock" },
                        { id: "HG002", name: "Lettuce - Butterhead", description: "Soft buttery texture 100g pack", price: 90, availability: "In Stock" }
                    ]
                }
            };
            
            // Populate UI with sample data
            populateProductCategories();
        }
        
        // Start fetching data when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            log('DOM content loaded, starting data fetch');
            fetchProductData();
        });
    </script>
</body>
</html> 